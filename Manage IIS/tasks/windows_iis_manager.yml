---
- name: Inicializar lista de linhas do relatório
  ansible.builtin.set_fact:
    _iis_rows: []

- name: Normalizar flags e operações no host Windows (evita skip e loop)
  ansible.builtin.set_fact:
    iis_manage_pools_eff: >-
      {{
        (iis_manage_pools | default(true))
        if ((iis_manage_pools | default(true)) is boolean)
        else ((iis_manage_pools | string | lower | trim) in ['sim','s','yes','y','true','1','on'])
      }}
    iis_manage_service_eff: >-
      {{
        (iis_manage_service | default(false))
        if ((iis_manage_service | default(false)) is boolean)
        else ((iis_manage_service | string | lower | trim) in ['sim','s','yes','y','true','1','on'])
      }}
    iis_pool_operation_eff: "{{ (iis_pool_operation | default('start')) | string | lower | trim }}"
    iis_service_operation_eff: "{{ (iis_service_operation | default('restart')) | string | lower | trim }}"
    iis_pool_max_retries_eff: "{{ (iis_pool_max_retries | default(3)) | int }}"
    iis_service_max_retries_eff: "{{ (iis_service_max_retries | default(3)) | int }}"
    iis_pools_norm_eff: "{{ iis_pools_norm | default([]) }}"
    iis_services_norm_eff: "{{ iis_services_norm | default(['WAS','W3SVC','IISADMIN']) }}"

- name: Validar operações no host (aceita info)
  ansible.builtin.assert:
    that:
      - iis_pool_operation_eff in ['start','stop','restart','info']
      - iis_service_operation_eff in ['start','stop','restart','info']
    fail_msg: "Operação inválida. Use start|stop|restart|info."

- name: Verificar se módulo WebAdministration/IIS está disponível
  when: iis_manage_pools_eff
  ansible.windows.win_powershell:
    script: |
      if (-not (Get-Module -ListAvailable -Name WebAdministration)) {
        Write-Output "MISSING_WEBADMIN"
      } else {
        Write-Output "OK"
      }
  register: webadmin_check
  changed_when: false
  failed_when: false

- name: Registrar erro e encerrar host se IIS/WebAdministration não estiver instalado
  when:
    - iis_manage_pools_eff
    - webadmin_check is defined
    - "'MISSING_WEBADMIN' in (webadmin_check.output | default([]) | join(''))"
  block:
    - ansible.builtin.set_fact:
        iis_host_report:
          host: "{{ inventory_hostname }}"
          os: "windows"
          rows: []
          error: "Módulo WebAdministration/IIS não encontrado neste host."
    - ansible.builtin.meta: end_host

- name: Coletar Application Pools do IIS (BÁSICO)
  when: iis_manage_pools_eff
  ansible.windows.win_powershell:
    script: |
      Import-Module WebAdministration
      $pools = Get-IISAppPool | Select-Object Name, @{Name='State';Expression={$_.State.ToString()}}
      $pools | ConvertTo-Json -Compress
  register: iis_pools_basic_raw
  changed_when: false
  failed_when: false

- name: Parse pools básico (inicial) - JSON
  when: iis_manage_pools_eff
  ansible.builtin.set_fact:
    _iis_pools_basic_parsed: >-
      {{
        (iis_pools_basic_raw.output | default([]) | join('') | trim | default('[]'))
        | from_json
      }}

- name: Normalizar lista de pools (inicial) - sempre lista
  when: iis_manage_pools_eff
  ansible.builtin.set_fact:
    _iis_pools_basic_all: >-
      {{
        [_iis_pools_basic_parsed]
        if _iis_pools_basic_parsed is mapping
        else (_iis_pools_basic_parsed | default([]))
      }}

- name: "Criar dicionário { pool: state } (estado inicial)"
  when: iis_manage_pools_eff
  ansible.builtin.set_fact:
    iis_pools_states_initial: >-
      {%- set out = {} -%}
      {%- for p in (_iis_pools_basic_all | default([])) -%}
        {%- set _ = out.update({ (p.Name | string): (p.State | string) }) -%}
      {%- endfor -%}
      {{ out }}

- name: Falhar se não conseguiu listar pools (evita “rodar em vazio”)
  ansible.builtin.fail:
    msg: "Não foi possível listar Application Pools no host. Verifique permissões do WinRM e IIS."
  vars:
    _len: "{{ iis_pools_states_initial | default({}) | length }}"
  when:
    - iis_manage_pools_eff
    - (_len | int) == 0

- name: Coletar INFO de pools (somente quando operação=info)
  when:
    - iis_manage_pools_eff
    - iis_pool_operation_eff == 'info'
  ansible.windows.win_powershell:
    script: |
      Import-Module WebAdministration

      $sites = @()
      try { $sites = Get-Website | Select-Object Name, ApplicationPool } catch { $sites = @() }

      $apps = @()
      try {
        if (Get-Command Get-WebApplication -ErrorAction SilentlyContinue) {
          $apps = Get-WebApplication | Select-Object Site, Path, ApplicationPool
        }
      } catch { $apps = @() }

      $out = @{}
      foreach ($p in (Get-IISAppPool)) {
        $name = $p.Name
        $item = Get-Item ("IIS:\AppPools\{0}" -f $name) -ErrorAction SilentlyContinue

        $runtime   = if ($item) { $item.managedRuntimeVersion } else { "" }
        $pipeline  = if ($item) { $item.managedPipelineMode.ToString() } else { "" }
        $autoStart = if ($item) { [bool]$item.autoStart } else { $null }
        $startMode = if ($item) { $item.startMode.ToString() } else { "" }

        $siteNames = @()
        try { $siteNames = ($sites | Where-Object { $_.ApplicationPool -eq $name } | Select-Object -ExpandProperty Name) } catch { $siteNames = @() }

        $appCount = 0
        try { $appCount = ($apps | Where-Object { $_.ApplicationPool -eq $name }).Count } catch { $appCount = 0 }

        $out[$name] = @{
          runtime   = $runtime
          pipeline  = $pipeline
          autoStart = $autoStart
          startMode = $startMode
          sites     = ($siteNames -join ",")
          appsCount = $appCount
        }
      }

      $out | ConvertTo-Json -Compress
  register: iis_pools_info_raw
  changed_when: false
  failed_when: false

- name: Parse INFO pools (dict) ou set vazio
  when: iis_manage_pools_eff
  ansible.builtin.set_fact:
    iis_pools_details_initial: >-
      {{
        (iis_pool_operation_eff == 'info')
        | ternary(
            (
              (iis_pools_info_raw.output | default([]) | join('') | trim)
              | default('{}', true)
              | from_json
            ),
            {}
          )
      }}

- name: Determinar pools alvo (todos ou apenas os informados)
  when: iis_manage_pools_eff
  ansible.builtin.set_fact:
    _iis_pools_effective: >-
      {%- set all = iis_pools_states_initial.keys() | list -%}
      {%- if (iis_pools_norm_eff | length) > 0 -%}
        {{ iis_pools_norm_eff | map('string') | list | intersect(all) }}
      {%- else -%}
        {{ all }}
      {%- endif -%}
    _iis_pools_missing_requested: >-
      {%- set all = iis_pools_states_initial.keys() | list -%}
      {%- if (iis_pools_norm_eff | length) > 0 -%}
        {{ iis_pools_norm_eff | map('string') | list | difference(all) }}
      {%- else -%}
        {{ [] }}
      {%- endif -%}

- name: Determinar pools que precisam de ação
  when: iis_manage_pools_eff
  ansible.builtin.set_fact:
    _iis_pools_needing_action: >-
      {%- set op = (iis_pool_operation_eff) -%}
      {%- set out = [] -%}
      {%- if op == 'info' -%}
        {{ out }}
      {%- else -%}
        {%- for name, st in iis_pools_states_initial.items() -%}
          {%- if name in _iis_pools_effective -%}
            {%- if op == 'restart' -%}
              {%- set _ = out.append(name) -%}
            {%- elif op == 'start' and (st | string) != 'Started' -%}
              {%- set _ = out.append(name) -%}
            {%- elif op == 'stop' and (st | string) != 'Stopped' -%}
              {%- set _ = out.append(name) -%}
            {%- endif -%}
          {%- endif -%}
        {%- endfor -%}
        {{ out }}
      {%- endif -%}

- name: Aplicar operação nos Application Pools necessários
  when:
    - iis_manage_pools_eff
    - iis_pool_operation_eff != 'info'
    - (_iis_pools_needing_action | length) > 0
  ansible.windows.win_powershell:
    script: |
      Import-Module WebAdministration
      $Name = "{{ item }}"
      $Operation = "{{ iis_pool_operation_eff }}"
      $Max = {{ iis_pool_max_retries_eff }}

      function Get-PoolState([string]$n) {
        $p = Get-IISAppPool -Name $n -ErrorAction SilentlyContinue
        if (-not $p) { return "MISSING" }
        return $p.State.ToString()
      }

      $initial = Get-PoolState $Name
      if ($initial -eq "MISSING") {
        Write-Output ("MISSING: {0}" -f $Name)
        exit 2
      }

      $success = $false
      $st = $initial
      $lastErr = ""

      for ($i = 1; $i -le $Max; $i++) {

        try {
          if ($Operation -eq "restart") {
            $cur = Get-PoolState $Name
            if ($cur -ne "Stopped") {
              Stop-WebAppPool -Name $Name -ErrorAction Stop | Out-Null
              Start-Sleep -Seconds 2
            }
            Start-WebAppPool -Name $Name -ErrorAction Stop | Out-Null

          } elseif ($Operation -eq "stop") {
            $cur = Get-PoolState $Name
            if ($cur -ne "Stopped") {
              Stop-WebAppPool -Name $Name -ErrorAction Stop | Out-Null
            }

          } else {
            $cur = Get-PoolState $Name
            if ($cur -ne "Started") {
              Start-WebAppPool -Name $Name -ErrorAction Stop | Out-Null
            }
          }

        } catch {
          $lastErr = $_.Exception.Message
        }

        Start-Sleep -Seconds 2
        $st = Get-PoolState $Name

        if (($Operation -in @("start","restart")) -and ($st -eq "Started")) { $success = $true; break }
        if (($Operation -eq "stop") -and ($st -eq "Stopped")) { $success = $true; break }
      }

      if (-not $success) {
        $msg = ("FAILED: {0} initial={1} final={2}" -f $Name, $initial, $st)
        if ($lastErr) { $msg = $msg + " err=" + $lastErr }
        Write-Output $msg
        exit 1
      } else {
        Write-Output ("OK: {0} initial={1} final={2}" -f $Name, $initial, $st)
      }
  register: iis_pools_actions
  changed_when: false
  failed_when: false
  loop: "{{ _iis_pools_needing_action }}"
  loop_control:
    label: "{{ item }}"

- name: Definir estado final igual ao inicial (op=info)
  when:
    - iis_manage_pools_eff
    - iis_pool_operation_eff == 'info'
  ansible.builtin.set_fact:
    iis_pools_states_final: "{{ iis_pools_states_initial }}"
    iis_pools_details_final: "{{ iis_pools_details_initial }}"
    iis_pools_actions: { "results": [] }

- name: Coletar Application Pools do IIS (BÁSICO final)
  when:
    - iis_manage_pools_eff
    - iis_pool_operation_eff != 'info'
  ansible.windows.win_powershell:
    script: |
      Import-Module WebAdministration
      $pools = Get-IISAppPool | Select-Object Name, @{Name='State';Expression={$_.State.ToString()}}
      $pools | ConvertTo-Json -Compress
  register: iis_pools_basic_raw_final
  changed_when: false
  failed_when: false

- name: Parse pools básico (final) - JSON
  when:
    - iis_manage_pools_eff
    - iis_pool_operation_eff != 'info'
  ansible.builtin.set_fact:
    _iis_pools_basic_parsed_final: >-
      {{
        (iis_pools_basic_raw_final.output | default([]) | join('') | trim | default('[]'))
        | from_json
      }}

- name: Normalizar lista de pools (final) - sempre lista
  when:
    - iis_manage_pools_eff
    - iis_pool_operation_eff != 'info'
  ansible.builtin.set_fact:
    _iis_pools_basic_all_final: >-
      {{
        [_iis_pools_basic_parsed_final]
        if _iis_pools_basic_parsed_final is mapping
        else (_iis_pools_basic_parsed_final | default([]))
      }}

- name: "Criar dicionário { pool: state } (estado final)"
  when:
    - iis_manage_pools_eff
    - iis_pool_operation_eff != 'info'
  ansible.builtin.set_fact:
    iis_pools_states_final: >-
      {%- set out = {} -%}
      {%- for p in (_iis_pools_basic_all_final | default([])) -%}
        {%- set _ = out.update({ (p.Name | string): (p.State | string) }) -%}
      {%- endfor -%}
      {{ out }}
    iis_pools_details_final: {}

- name: Construir linhas do relatório (App Pools)
  when: iis_manage_pools_eff
  ansible.builtin.set_fact:
    _iis_rows: >-
      {%- set out = (_iis_rows | default([]) | list) -%}
      {%- set op = iis_pool_operation_eff -%}

      {%- for name in (_iis_pools_effective | default([])) -%}
        {%- set initial = iis_pools_states_initial.get(name, 'Unknown') -%}
        {%- set final = iis_pools_states_final.get(name, 'Unknown') -%}
        {%- set acted = (name in (_iis_pools_needing_action | default([]))) -%}
        {%- set action = (op if (op == 'info' or acted) else 'none') -%}

        {%- if op == 'info' -%}
          {%- set ok = (initial != 'Unknown') -%}
        {%- elif op in ['start','restart'] -%}
          {%- set ok = (final == 'Started') -%}
        {%- elif op == 'stop' -%}
          {%- set ok = (final == 'Stopped') -%}
        {%- else -%}
          {%- set ok = (final in ['Started','Stopped']) -%}
        {%- endif -%}

        {%- set msg = 'Sem ação – já estava no estado desejado' -%}
        {%- if op == 'info' -%}
          {%- set msg = 'Apenas consulta (info)' -%}
        {%- else -%}
          {%- for rr in (iis_pools_actions.results | default([])) -%}
            {%- if rr.item == name -%}
              {%- set msg = (
                (rr.output | default([]) | join(''))
                | default(rr.stdout | default(rr.stderr | default('')))
              ) -%}
            {%- endif -%}
          {%- endfor -%}
        {%- endif -%}

        {%- set info = '' -%}
        {%- if op == 'info' -%}
          {%- set d = (iis_pools_details_initial.get(name, {}) if (iis_pools_details_initial is defined) else {}) -%}
          {%- set sites = (d.get('sites','') | string) -%}
          {%- if sites|length > 80 -%}{%- set sites = sites[0:80] ~ '…' -%}{%- endif -%}
          {%- set info = (
            'runtime=' ~ (d.get('runtime','')|string) ~
            '; pipeline=' ~ (d.get('pipeline','')|string) ~
            '; autoStart=' ~ (d.get('autoStart','')|string) ~
            '; startMode=' ~ (d.get('startMode','')|string) ~
            '; sites=' ~ sites ~
            '; apps=' ~ (d.get('appsCount','')|string)
          ) -%}
        {%- endif -%}

        {%- set _ = out.append({
              'kind': 'pool',
              'name': name,
              'action': action,
              'initial': initial,
              'final': final,
              'ok': ok,
              'info': info,
              'message': msg
            }) -%}
      {%- endfor -%}

      {%- for name in (_iis_pools_missing_requested | default([])) -%}
        {%- set _ = out.append({
              'kind': 'pool',
              'name': name,
              'action': op,
              'initial': 'absent',
              'final': 'absent',
              'ok': false,
              'info': 'absent',
              'message': 'Application Pool não encontrado no host'
            }) -%}
      {%- endfor -%}
      {{ out }}

- name: Normalizar lista de serviços alvo (Windows)
  when: iis_manage_service_eff
  ansible.builtin.set_fact:
    _iis_services_effective: "{{ iis_services_norm_eff | map('string') | list | unique }}"

- name: Ordenar serviços do IIS (dependências)
  when: iis_manage_service_eff
  ansible.builtin.set_fact:
    _iis_services_ordered: >-
      {%- set base = ['WAS','W3SVC','IISADMIN','AppHostSvc','WMSVC'] -%}
      {%- set eff = _iis_services_effective -%}
      {%- set ordered = [] -%}
      {%- for s in base -%}
        {%- if s in eff -%}{%- set _ = ordered.append(s) -%}{%- endif -%}
      {%- endfor -%}
      {%- for s in eff -%}
        {%- if s not in ordered -%}{%- set _ = ordered.append(s) -%}{%- endif -%}
      {%- endfor -%}
      {%- if iis_service_operation_eff == 'stop' -%}
        {{ ordered | reverse | list }}
      {%- else -%}
        {{ ordered }}
      {%- endif -%}

- name: Coletar informações dos serviços (INFO) - inicial (somente quando operação=info)
  when:
    - iis_manage_service_eff
    - iis_service_operation_eff == 'info'
  ansible.windows.win_powershell:
    script: |
      $NamesRaw = "{{ _iis_services_ordered | join(',') }}"
      $names = $NamesRaw.Split(',') | ForEach-Object { $_.Trim() } | Where-Object { $_ -and $_.Length -gt 0 }

      $out = foreach ($n in $names) {
        $filter = "Name='{0}'" -f ($n.Replace("'", "''"))
        $s = Get-CimInstance -ClassName Win32_Service -Filter $filter -ErrorAction SilentlyContinue
        if ($s) {
          [pscustomobject]@{
            Name        = $s.Name
            DisplayName = $s.DisplayName
            StartMode   = $s.StartMode
            State       = $s.State
            Status      = $s.Status
            PathName    = $s.PathName
          }
        } else {
          [pscustomobject]@{
            Name    = $n
            Missing = $true
          }
        }
      }

      $out | ConvertTo-Json -Compress
  register: _iis_svc_info_initial_raw
  changed_when: false
  failed_when: false

- name: Parse JSON dos serviços (INFO inicial) - JSON
  when:
    - iis_manage_service_eff
    - iis_service_operation_eff == 'info'
  ansible.builtin.set_fact:
    _iis_svc_info_initial_parsed: >-
      {{
        (_iis_svc_info_initial_raw.output | default([]) | join('') | trim | default('[]'))
        | from_json
      }}

- name: Normalizar lista de serviços INFO (inicial) - sempre lista
  when:
    - iis_manage_service_eff
    - iis_service_operation_eff == 'info'
  ansible.builtin.set_fact:
    _iis_svc_info_initial_all: >-
      {{
        [_iis_svc_info_initial_parsed]
        if _iis_svc_info_initial_parsed is mapping
        else (_iis_svc_info_initial_parsed | default([]))
      }}

- name: Criar dict de detalhes de serviços (INFO inicial)
  when:
    - iis_manage_service_eff
    - iis_service_operation_eff == 'info'
  ansible.builtin.set_fact:
    iis_services_details_initial: >-
      {%- set out = {} -%}
      {%- for s in (_iis_svc_info_initial_all | default([])) -%}
        {%- set _ = out.update({ (s.Name | string): {
          'displayName': (s.DisplayName | default('') | string),
          'startMode': (s.StartMode | default('') | string),
          'state': (s.State | default('') | string),
          'status': (s.Status | default('') | string),
          'pathName': (s.PathName | default('') | string),
          'missing': ((s.Missing is defined) and (s.Missing | bool))
        }}) -%}
      {%- endfor -%}
      {{ out }}

- name: Coletar status dos serviços (BÁSICO) - inicial (quando operação != info)
  when:
    - iis_manage_service_eff
    - iis_service_operation_eff != 'info'
  ansible.windows.win_powershell:
    script: |
      $NamesRaw = "{{ _iis_services_ordered | join(',') }}"
      $names = $NamesRaw.Split(',') | ForEach-Object { $_.Trim() } | Where-Object { $_ -and $_.Length -gt 0 }

      $out = foreach ($n in $names) {
        $svc = Get-Service -Name $n -ErrorAction SilentlyContinue
        if ($svc) {
          [pscustomobject]@{
            Name  = $svc.Name
            State = $svc.Status.ToString()
          }
        } else {
          [pscustomobject]@{
            Name    = $n
            Missing = $true
          }
        }
      }

      $out | ConvertTo-Json -Compress
  register: _iis_svc_basic_initial_raw
  changed_when: false
  failed_when: false

- name: Parse serviços (BÁSICO inicial) - JSON
  when:
    - iis_manage_service_eff
    - iis_service_operation_eff != 'info'
  ansible.builtin.set_fact:
    _iis_svc_basic_initial_parsed: >-
      {{
        (_iis_svc_basic_initial_raw.output | default([]) | join('') | trim | default('[]'))
        | from_json
      }}

- name: Normalizar lista de serviços BÁSICO (inicial) - sempre lista
  when:
    - iis_manage_service_eff
    - iis_service_operation_eff != 'info'
  ansible.builtin.set_fact:
    _iis_svc_basic_initial_all: >-
      {{
        [_iis_svc_basic_initial_parsed]
        if _iis_svc_basic_initial_parsed is mapping
        else (_iis_svc_basic_initial_parsed | default([]))
      }}

- name: Criar dict de detalhes de serviços (BÁSICO inicial)
  when:
    - iis_manage_service_eff
    - iis_service_operation_eff != 'info'
  ansible.builtin.set_fact:
    iis_services_details_initial: >-
      {%- set out = {} -%}
      {%- for s in (_iis_svc_basic_initial_all | default([])) -%}
        {%- set _ = out.update({ (s.Name | string): {
          'displayName': '',
          'startMode': '',
          'state': (s.State | default('') | string),
          'status': '',
          'pathName': '',
          'missing': ((s.Missing is defined) and (s.Missing | bool))
        }}) -%}
      {%- endfor -%}
      {{ out }}

- name: Criar listas present/missing de serviços (inicial)
  when: iis_manage_service_eff
  ansible.builtin.set_fact:
    _iis_services_missing: >-
      {%- set out = [] -%}
      {%- for name in (_iis_services_ordered | default([])) -%}
        {%- set d = iis_services_details_initial.get(name, {}) -%}
        {%- if d.get('missing', false) -%}
          {%- set _ = out.append(name) -%}
        {%- endif -%}
      {%- endfor -%}
      {{ out }}
    _iis_services_present_ordered: >-
      {%- set out = [] -%}
      {%- for name in (_iis_services_ordered | default([])) -%}
        {%- if name not in (_iis_services_missing | default([])) -%}
          {%- set _ = out.append(name) -%}
        {%- endif -%}
      {%- endfor -%}
      {{ out }}

- name: Ajustar lista missing
  when: iis_manage_service_eff
  ansible.builtin.set_fact:
    _iis_services_missing: "{{ (_iis_services_missing | default([])) | difference(_iis_services_present_ordered | default([])) }}"

- name: Executar operação nos serviços do IIS com retries (Windows)
  when:
    - iis_manage_service_eff
    - iis_service_operation_eff != 'info'
    - (_iis_services_present_ordered | length) > 0
  ansible.windows.win_powershell:
    script: |
      $Name = "{{ item }}"
      $Operation = "{{ iis_service_operation_eff }}"
      $Max = {{ iis_service_max_retries_eff }}

      $svc = Get-Service -Name $Name -ErrorAction SilentlyContinue
      if (-not $svc) {
        Write-Output ("MISSING: {0}" -f $Name)
        exit 2
      }

      $initial = $svc.Status.ToString()
      $success = $false
      $st = $initial

      for ($i = 1; $i -le $Max; $i++) {
        if ($Operation -eq 'restart') {
          Restart-Service -Name $Name -Force -ErrorAction SilentlyContinue
        } elseif ($Operation -eq 'stop') {
          Stop-Service -Name $Name -Force -ErrorAction SilentlyContinue
        } else {
          Start-Service -Name $Name -ErrorAction SilentlyContinue
        }

        Start-Sleep -Seconds 2
        $st = (Get-Service -Name $Name -ErrorAction SilentlyContinue).Status.ToString()

        if (($Operation -in @('start','restart')) -and ($st -eq 'Running')) { $success = $true; break }
        if (($Operation -eq 'stop') -and ($st -eq 'Stopped')) { $success = $true; break }
      }

      if (-not $success) {
        Write-Output ("FAILED: {0} initial={1} final={2}" -f $Name, $initial, $st)
        exit 1
      } else {
        Write-Output ("OK: {0} initial={1} final={2}" -f $Name, $initial, $st)
      }
  loop: "{{ _iis_services_present_ordered }}"
  loop_control:
    label: "{{ item }}"
  register: _iis_svc_actions
  changed_when: false
  failed_when: false

- name: Definir estado final igual ao inicial (op=info)
  when:
    - iis_manage_service_eff
    - iis_service_operation_eff == 'info'
  ansible.builtin.set_fact:
    iis_services_details_final: "{{ iis_services_details_initial }}"
    _iis_svc_actions: { "results": [] }

- name: Coletar status dos serviços (BÁSICO) - final (quando operação != info)
  when:
    - iis_manage_service_eff
    - iis_service_operation_eff != 'info'
  ansible.windows.win_powershell:
    script: |
      $NamesRaw = "{{ _iis_services_ordered | join(',') }}"
      $names = $NamesRaw.Split(',') | ForEach-Object { $_.Trim() } | Where-Object { $_ -and $_.Length -gt 0 }

      $out = foreach ($n in $names) {
        $svc = Get-Service -Name $n -ErrorAction SilentlyContinue
        if ($svc) {
          [pscustomobject]@{
            Name  = $svc.Name
            State = $svc.Status.ToString()
          }
        } else {
          [pscustomobject]@{
            Name    = $n
            Missing = $true
          }
        }
      }

      $out | ConvertTo-Json -Compress
  register: _iis_svc_basic_final_raw
  changed_when: false
  failed_when: false

- name: Parse serviços (BÁSICO final) - JSON
  when:
    - iis_manage_service_eff
    - iis_service_operation_eff != 'info'
  ansible.builtin.set_fact:
    _iis_svc_basic_final_parsed: >-
      {{
        (_iis_svc_basic_final_raw.output | default([]) | join('') | trim | default('[]'))
        | from_json
      }}

- name: Normalizar lista de serviços BÁSICO (final) - sempre lista
  when:
    - iis_manage_service_eff
    - iis_service_operation_eff != 'info'
  ansible.builtin.set_fact:
    _iis_svc_basic_final_all: >-
      {{
        [_iis_svc_basic_final_parsed]
        if _iis_svc_basic_final_parsed is mapping
        else (_iis_svc_basic_final_parsed | default([]))
      }}

- name: Criar dict de detalhes de serviços (BÁSICO final)
  when:
    - iis_manage_service_eff
    - iis_service_operation_eff != 'info'
  ansible.builtin.set_fact:
    iis_services_details_final: >-
      {%- set out = {} -%}
      {%- for s in (_iis_svc_basic_final_all | default([])) -%}
        {%- set _ = out.update({ (s.Name | string): {
          'displayName': '',
          'startMode': '',
          'state': (s.State | default('') | string),
          'status': '',
          'pathName': '',
          'missing': ((s.Missing is defined) and (s.Missing | bool))
        }}) -%}
      {%- endfor -%}
      {{ out }}

- name: Construir linhas do relatório (Serviços IIS)
  when: iis_manage_service_eff
  ansible.builtin.set_fact:
    _iis_rows: >-
      {%- set out = (_iis_rows | default([]) | list) -%}
      {%- set op = iis_service_operation_eff -%}

      {%- for name in (_iis_services_present_ordered | default([])) -%}
        {%- set d0 = (iis_services_details_initial.get(name, {}) if (iis_services_details_initial is defined) else {}) -%}
        {%- set d1 = (iis_services_details_final.get(name, {}) if (iis_services_details_final is defined) else {}) -%}

        {%- set initial = (d0.get('state','unknown') | string) -%}
        {%- set final = (d1.get('state','unknown') | string) -%}

        {# se for info e estiver missing, força absent #}
        {%- if op == 'info' and (d0.get('missing', false)) -%}
          {%- set initial = 'absent' -%}
          {%- set final = 'absent' -%}
        {%- endif -%}

        {# calcula OK #}
        {%- if op == 'info' -%}
          {%- set ok = (d0.get('missing', false) == false) -%}
        {%- elif op in ['start','restart'] -%}
          {%- set ok = (final == 'Running') -%}
        {%- elif op == 'stop' -%}
          {%- set ok = (final == 'Stopped') -%}
        {%- else -%}
          {%- set ok = (final in ['Running','Stopped']) -%}
        {%- endif -%}

        {%- set msg = '' -%}
        {%- if op == 'info' -%}
          {%- set msg = 'Apenas consulta (info)' -%}
        {%- else -%}
          {%- for r in (_iis_svc_actions.results | default([])) -%}
            {%- if r.item == name -%}
              {%- set msg = (
                (r.output | default([]) | join(''))
                | default(r.stdout | default(r.stderr | default('')))
              ) -%}
            {%- endif -%}
          {%- endfor -%}
        {%- endif -%}

        {%- set info = '' -%}
        {%- if op == 'info' -%}
          {%- set disp = (d0.get('displayName','') | string) -%}
          {%- if disp|length > 60 -%}{%- set disp = disp[0:60] ~ '…' -%}{%- endif -%}

          {%- set path = (d0.get('pathName','') | string) -%}
          {%- if path|length > 90 -%}{%- set path = path[0:90] ~ '…' -%}{%- endif -%}

          {%- set info = (
            'display=' ~ disp ~
            '; startMode=' ~ (d0.get('startMode','')|string) ~
            '; path=' ~ path
          ) -%}
        {%- endif -%}

        {%- set _ = out.append({
              'kind': 'service',
              'name': name,
              'action': op,
              'initial': initial,
              'final': final,
              'ok': ok,
              'info': info,
              'message': msg
            }) -%}
      {%- endfor -%}

      {%- for s in (_iis_services_missing | default([])) -%}
        {%- set _ = out.append({
              'kind': 'service',
              'name': s,
              'action': op,
              'initial': 'absent',
              'final': 'absent',
              'ok': false,
              'info': 'absent',
              'message': 'Serviço não encontrado no host'
            }) -%}
      {%- endfor -%}
      {{ out }}

- name: Ajustar relatório final por host (Windows/IIS)
  ansible.builtin.set_fact:
    iis_host_report:
      host: "{{ inventory_hostname }}"
      os: "windows"
      rows: "{{ _iis_rows | default([]) }}"
      pools_operation: "{{ iis_pool_operation_eff }}"
      services_operation: "{{ iis_service_operation_eff }}"
      manage_pools: "{{ iis_manage_pools_eff }}"
      manage_service: "{{ iis_manage_service_eff }}"
