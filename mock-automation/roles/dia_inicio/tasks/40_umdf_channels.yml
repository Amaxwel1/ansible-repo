---
- name: Aguardar 5 minutos para inicio do Start Day
  ansible.builtin.pause:
    seconds: "{{ umdf_pause_start | int }}"

- name: Garantir ansible_date_time disponível (UMDF)
  ansible.builtin.setup:
    gather_subset: ["!all", "!min", "date_time"]
  when: ansible_date_time is not defined

- name: Marcar horário de início do UMDF
  ansible.builtin.set_fact:
    umdf_start_hhmm: "{{ (ansible_date_time.time | default(''))[0:5] }}"
  when: umdf_start_before_check | bool
  changed_when: false

- name: Iniciar UMDF (startday.sh) antes do check
  ansible.builtin.shell: |
    set -e
    cd {{ umdf_start_script_dir }}
    nohup {{ umdf_start_script }} >/tmp/umdf-startday.log 2>&1 &
  delegate_to: "{{ umdf_host }}"
  when: umdf_start_before_check | bool
  changed_when: true

- name: Aguardar estabilização do UMDF após start
  ansible.builtin.pause:
    seconds: "{{ umdf_start_wait_seconds | int }}"
  when: umdf_start_before_check | bool

- name: Executar comando telnet para listar canais UMDF
  ansible.builtin.shell: |
    set -e
    (
      echo open {{ umdf_telnet_host }} {{ umdf_telnet_port }}
      sleep {{ umdf_telnet_sleep }}
      echo list
      sleep {{ umdf_telnet_sleep }}
      echo exit
    ) | telnet || true
  delegate_to: "{{ umdf_host }}"
  register: umdf_telnet_output
  changed_when: false

- name: Inicializar lista de canais UMDF
  ansible.builtin.set_fact:
    umdf_channels: []

- name: Extrair canais do output (linhas com SYNC)
  ansible.builtin.set_fact:
    umdf_channels: >-
      {{
        umdf_channels
        + [ {
              "linha": item,
              "canal": (item.split(" ")[0]),
              "delta": (item.split(" ")[-1] | int)
            } ]
      }}
  loop: "{{ umdf_telnet_output.stdout_lines | select('contains', 'SYNC') | list }}"

- name: Marcar canais com delta alto
  ansible.builtin.set_fact:
    umdf_channels_high_delta: >-
      {{
        umdf_channels
        | selectattr('delta', '>', umdf_delta_threshold | int)
        | list
      }}

- name: (Opcional) Reiniciar canais com delta alto
  ansible.builtin.shell: |
    set -e
    (
      echo open {{ umdf_telnet_host }} {{ umdf_telnet_port }}
      sleep {{ umdf_telnet_sleep }}
      echo restart {{ item.canal }}
      sleep {{ umdf_telnet_sleep }}
      echo exit
    ) | telnet || true
  delegate_to: "{{ umdf_host }}"
  loop: "{{ umdf_channels_high_delta }}"
  when: umdf_restart_on_high_delta | bool
  register: umdf_restart
  changed_when: false

- name: Resumo UMDF canais
  ansible.builtin.set_fact:
    inicio_umdf_report:
      start_time: "{{ umdf_start_hhmm | default('N/A') }}"
      channels: "{{ umdf_channels }}"
      high_delta: "{{ umdf_channels_high_delta }}"
      delta_threshold: "{{ umdf_delta_threshold | int }}"
      restart_on_high_delta: "{{ umdf_restart_on_high_delta }}"
      restart_executions: >-
        {{
          (
            umdf_restart.results
            | default([])
            | selectattr('stdout', 'defined')
            | map(attribute='stdout')
            | list
          )
          if (umdf_restart is defined and umdf_restart.results is defined)
          else []
        }}
