---
- name: Descobrir pod do DDS-Stream (TH)
  kubernetes.core.k8s_info:
    kubeconfig: "{{ kubeconfig_th }}"
    api_version: v1
    kind: Pod
    namespace: "{{ dds_namespace }}"
    label_selectors:
      - "deploymentconfig={{ dds_dc_name }}"
  register: dds_pods

- name: Selecionar pod running do DDS-Stream
  ansible.builtin.set_fact:
    dds_stream_pod: >-
      {{
        (
          dds_pods.resources | default([])
          | selectattr('status.phase', 'equalto', 'Running')
          | list
        )[0].metadata.name
        | default(omit)
      }}

- name: Executar testes de telnet no pod DDS
  kubernetes.core.k8s_exec:
    kubeconfig: "{{ kubeconfig_th }}"
    namespace: "{{ dds_namespace }}"
    pod: "{{ dds_stream_pod }}"
    command: >
      sh -c '(echo | telnet {{ item.host }} {{ item.port }} || true)'
  loop: "{{ dds_telnet_tests }}"
  loop_control:
    label: "{{ item.name }}"
  register: dds_telnet_results
  failed_when: false
  changed_when: false

- name: Montar lista de testes DDS (sempre registra, mesmo com falha)
  ansible.builtin.set_fact:
    dds_tests_list: "{{ dds_tests_list | default([]) + [ {
      'name': item.name,
      'host': item.host,
      'port': item.port,
      'rc': (dds_telnet_results.results[idx].rc
      | default(dds_telnet_results.results[idx].return_code | default(1))),
      'ok': ((dds_telnet_results.results[idx].rc
      | default(dds_telnet_results.results[idx].return_code | default(1))) == 0)
      } ] }}"
  loop: "{{ dds_telnet_tests | default([]) }}"
  loop_control:
    index_var: idx
  changed_when: false

- name: Executar 'list' via telnet dentro do pod DDS (porta 4010)
  kubernetes.core.k8s_exec:
    kubeconfig: "{{ kubeconfig_th }}"
    namespace: "{{ dds_namespace }}"
    pod: "{{ dds_stream_pod }}"
    command: >
      sh -c '(echo list && sleep {{ dds_telnet_sleep | default(2) }}) |
             telnet 127.0.0.1 4010'
  register: dds_list
  failed_when: dds_list.rc not in [0, 1]
  changed_when: false

- name: Debug bruto do LIST do DDS (opcional)
  ansible.builtin.debug:
    var: dds_list.stdout_lines
  when: debug_dds_list | default(false)

- name: Inicializar lista de canais DDS
  ansible.builtin.set_fact:
    _dds_channels: []
  changed_when: false

- name: Extrair canais retornados pelo DDS-Stream
  ansible.builtin.set_fact:
    _dds_channels: >-
      {{
        _dds_channels
        + [ {
              "canal": (item.split()[0] | regex_search('[0-9]+')),
              "delta": (item.split()[-1] | int)
            } ]
      }}
  loop: "{{ dds_list.stdout_lines | default([]) | select('contains', 'PROCESSOR-CANAL') | list }}"
  changed_when: false

- name: Montar resumo DDS-Stream (pods + testes + canais)
  ansible.builtin.set_fact:
    inicio_dds_stream_report:
      namespace: "{{ dds_namespace }}"
      pod: "{{ dds_stream_pod | default('N/A') }}"
      tests: "{{ dds_tests_list | default([]) }}"
      channels: "{{ _dds_channels | default([]) }}"
      delta_threshold: "{{ dds_delta_threshold | default(30) }}"
  changed_when: false
