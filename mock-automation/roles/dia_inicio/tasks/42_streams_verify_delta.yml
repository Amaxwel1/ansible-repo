---
- name: Zerando acumuladores do Streams
  ansible.builtin.set_fact:
    streams_all_channels: []
    streams_channels: []
  changed_when: false

- name: Executar comando de start dentro do pod {{ streams_pod }}
  kubernetes.core.k8s_exec:
    kubeconfig: "{{ kubeconfig_th }}"
    pod: "{{ streams_pod }}"
    namespace: "{{ streams_namespace }}"
    command: >
      sh -lc '
      START_TS=$(date +%s);
      START_HUMAN=$(date "+%Y-%m-%d %H:%M:%S");
      echo "__START_TS__=${START_TS}";
      echo "__START_HUMAN__=${START_HUMAN}";
      echo "__STATUS__=STARTING";

      {{ streams_start_command | default("start") }} >/dev/null 2>&1;
      RC=$?;

      END_TS=$(date +%s);
      END_HUMAN=$(date "+%Y-%m-%d %H:%M:%S");
      echo "__END_TS__=${END_TS}";
      echo "__END_HUMAN__=${END_HUMAN}";
      echo "__DURATION_SECONDS__=$(( END_TS - START_TS ))";

      if [ "$RC" -eq 3 ]; then
        echo "__STATUS__=EXIT3_OK";
        exit 3;
      elif [ "$RC" -eq 0 ]; then
        echo "__STATUS__=OK";
        exit 0;
      else
        echo "__STATUS__=START_FAILED_RC_${RC}";
        exit "$RC";
      fi
      '
  register: streams_start
  failed_when: streams_start.rc not in [0, 3]
  changed_when: false

- name: Garantir ansible_date_time disponível (Streams)
  ansible.builtin.setup:
    gather_subset: ["!all", "!min", "date_time"]
  when: ansible_date_time is not defined

- name: Marcar horário de início do Streams (HH:MM)
  ansible.builtin.set_fact:
    streams_start_hhmm: "{{ (ansible_date_time.time | default(''))[0:5] }}"
    streams_telnet_endpoint: "{{ streams_telnet_host }}:{{ streams_telnet_port }}"
  changed_when: false

- name: Executar 'list' via telnet dentro do pod {{ streams_pod }}
  kubernetes.core.k8s_exec:
    kubeconfig: "{{ kubeconfig_th }}"
    pod: "{{ streams_pod }}"
    namespace: "{{ streams_namespace }}"
    command: >
      sh -c '(echo list && sleep {{ streams_telnet_sleep }}) |
             telnet {{ streams_telnet_host }} {{ streams_telnet_port }}'
  register: streams_list
  failed_when: streams_list.rc not in [0, 1]
  changed_when: false

- name: Inicializar listas temporárias
  ansible.builtin.set_fact:
    _channels_all: []
    _channels_high_filtered: []
    _channels_synced: []
  changed_when: false

- name: Extrair todos os canais do output
  ansible.builtin.set_fact:
    _channels_all: >-
      {{
        _channels_all
        + [ {
              "canal": (item.split()[0] | regex_search('[0-9]+')),
              "delta": (item.split()[-1] | int)
            } ]
      }}
  loop: "{{ streams_list.stdout_lines | default([]) | select('contains', 'PROCESSOR-CANAL') | list }}"
  changed_when: false

- name: Filtrar canais sincronizados (DELTA <= limite)
  ansible.builtin.set_fact:
    _channels_synced: >-
      {{
        _channels_all
        | selectattr('delta', '<=', streams_delta_threshold | int)
        | list
      }}
  changed_when: false

- name: Filtrar canais com DELTA > limite
  ansible.builtin.set_fact:
    _channels_high_filtered: >-
      {{
        _channels_high_filtered + [ ch ]
      }}
  loop: "{{ _channels_all }}"
  loop_control:
    loop_var: ch
  when: ch.delta | int > streams_delta_threshold | int
  changed_when: false

- name: Acumular todos os canais de streams
  ansible.builtin.set_fact:
    streams_all_channels: >-
      {{
        streams_all_channels
        + [
            {
              "namespace": streams_namespace,
              "pod": streams_pod,
              "canal": ch['canal'],
              "delta": ch['delta']
            }
          ]
      }}
  loop: "{{ _channels_all }}"
  loop_control:
    loop_var: ch
  when: _channels_all | length > 0
  changed_when: false

- name: Acumular canais com DELTA alto
  ansible.builtin.set_fact:
    streams_channels: >-
      {{
        streams_channels
        + [
            {
              "namespace": streams_namespace,
              "pod": streams_pod,
              "canal": ch['canal'],
              "delta": ch['delta']
            }
          ]
      }}
  loop: "{{ _channels_high_filtered }}"
  loop_control:
    loop_var: ch
  when: _channels_high_filtered | length > 0
  changed_when: false

- name: (Opcional) Reiniciar canais com DELTA alto
  kubernetes.core.k8s_exec:
    kubeconfig: "{{ kubeconfig_th }}"
    pod: "{{ streams_pod }}"
    namespace: "{{ streams_namespace }}"
    command: >
      sh -c '(echo restart {{ ch.canal }} && sleep {{ streams_telnet_sleep }}) |
             telnet {{ streams_telnet_host }} {{ streams_telnet_port }}'
  loop: "{{ _channels_high_filtered }}"
  loop_control:
    loop_var: ch
  when:
    - _channels_high_filtered | length > 0
    - streams_restart_on_high_delta | bool
  register: streams_restart
  failed_when: streams_restart.rc not in [0, 1]
  changed_when: streams_restart.rc == 0

- name: Consolidar report do Streams
  ansible.builtin.set_fact:
    inicio_streams_report:
      start_time: "{{ streams_start_hhmm | default('N/A') }}"
      telnet_endpoint: "{{ streams_telnet_endpoint | default('N/A') }}"
      delta_threshold: "{{ streams_delta_threshold | int }}"
      pod: "{{ streams_pod }}"
      namespace: "{{ streams_namespace }}"
      channels: "{{ streams_channels | default([]) }}"
      all_channels: "{{ streams_all_channels | default([]) }}"
      synced_channels: "{{ _channels_synced | map(attribute='canal') | list }}"
      synced_count: "{{ (_channels_synced | length) | int }}"
  changed_when: false
