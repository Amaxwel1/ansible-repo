---
- name: Remover todos os pods do namespace cheetah
  ansible.builtin.shell: |
    export KUBECONFIG="{{ paths.kubeconfig_th }}"
    oc -n cheetah delete pod --all
  register: delete_cheetah_pods
  changed_when: delete_cheetah_pods.rc == 0
  failed_when: false

- name: Aguardar alguns segundos para os pods serem recriados
  ansible.builtin.pause:
    seconds: 60

- name: Listar pods atuais do namespace cheetah
  kubernetes.core.k8s_info:
    kubeconfig: "{{ paths.kubeconfig_th }}"
    kind: Pod
    namespace: cheetah
  register: cheetah_pods_info
  changed_when: false
  failed_when: false

- name: Inicializar lista de pods do cheetah
  ansible.builtin.set_fact:
    cheetah_pods_list: []

- name: Montar lista de pods com nome e fase
  ansible.builtin.set_fact:
    cheetah_pods_list: >-
      {{
        cheetah_pods_list
        + [
            {
              "name": item.metadata.name,
              "phase": item.status.phase | default('Unknown')
            }
          ]
      }}
  loop: "{{ cheetah_pods_info.resources | default([]) }}"
  loop_control:
    label: "{{ item.metadata.name | default('sem-nome') }}"
  changed_when: false

- name: Definir flag se todos os pods estão Running
  ansible.builtin.set_fact:
    cheetah_all_running: >-
      {{
        (cheetah_pods_list | length > 0)
        and
        (
          cheetah_pods_list
          | selectattr('phase', 'ne', 'Running')
          | list
          | length
        ) == 0
      }}
  changed_when: false

- name: Montar resumo do namespace cheetah para o relatório
  ansible.builtin.set_fact:
    inicio_cheetah_report:
      delete_output: "{{ delete_cheetah_pods.stdout | default('') }}"
      pods: "{{ cheetah_pods_list | default([]) }}"
      all_running: "{{ cheetah_all_running | default(false) }}"
