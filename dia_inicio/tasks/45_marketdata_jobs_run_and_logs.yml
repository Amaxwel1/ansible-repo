---
- name: Definir jobs e tempos
  ansible.builtin.set_fact:
    marketdata_jobs:
      - key: cadastro_papel
        dc_label: cadastro-papel-job
        timeout_seconds: 1200
        logs_since: "30m"
      - key: stock_cache
        dc_label: stock-cache-job
        timeout_seconds: 180
        logs_since: "10m"
      - key: start_day
        dc_label: start-day-job
        timeout_seconds: 600
        logs_since: "20m"
    marketdata_poll_interval: "{{ marketdata_poll_interval | default(10) | int }}"
    marketdata_start_command: "{{ marketdata_start_command | default('start') }}"
  changed_when: false

- name: Inicializar report de jobs
  ansible.builtin.set_fact:
    inicio_jobs_report: {}
  changed_when: false

- name: Executar jobs em sequÃªncia e aguardar exit#3
  ansible.builtin.shell: |
    set -euo pipefail
    export KUBECONFIG="{{ kubeconfig_th }}"
    NS="{{ marketdata_namespace_th }}"
    DC="{{ item.dc_label }}"
    TIMEOUT="{{ item.timeout_seconds }}"
    INTERVAL="{{ marketdata_poll_interval }}"
    LOGS_SINCE="{{ item.logs_since }}"
    START_CMD="{{ marketdata_start_command }}"

    START_TS="$(date +%s)"
    START_HUMAN="$(date '+%Y-%m-%d %H:%M:%S')"
    echo "__START_TS__=${START_TS}"
    echo "__START_HUMAN__=${START_HUMAN}"

    POD="$(oc -n "$NS" get pods -l deploymentconfig="$DC" -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || true)"
    if [ -z "${POD:-}" ]; then
      echo "__STATUS__=NO_POD"
      END_TS="$(date +%s)"
      END_HUMAN="$(date '+%Y-%m-%d %H:%M:%S')"
      echo "__END_TS__=${END_TS}"
      echo "__END_HUMAN__=${END_HUMAN}"
      echo "__DURATION_SECONDS__=$(( END_TS - START_TS ))"
      exit 2
    fi

    echo "__POD__=${POD}"
    echo "__STATUS__=STARTING"
    oc -n "$NS" exec "$POD" -- "$START_CMD" >/dev/null 2>&1 || true

    echo "__STATUS__=WAITING_EXIT3"
    END_DEADLINE=$(( $(date +%s) + TIMEOUT ))
    FOUND=0

    while [ "$(date +%s)" -lt "$END_DEADLINE" ]; do
      if oc -n "$NS" logs "$POD" --since="$LOGS_SINCE" 2>/dev/null | grep -qi 'exit#3'; then
        FOUND=1
        break
      fi
      sleep "$INTERVAL"
    done

    END_TS="$(date +%s)"
    END_HUMAN="$(date '+%Y-%m-%d %H:%M:%S')"
    echo "__END_TS__=${END_TS}"
    echo "__END_HUMAN__=${END_HUMAN}"
    echo "__DURATION_SECONDS__=$(( END_TS - START_TS ))"

    echo "__LOG_BEGIN__"
    oc -n "$NS" logs "$POD" --since="$LOGS_SINCE" 2>/dev/null | tail -n 200 || true
    echo "__LOG_END__"

    if [ "$FOUND" -eq 1 ]; then
      echo "__STATUS__=EXIT3_OK"
      exit 0
    else
      echo "__STATUS__=TIMEOUT_NO_EXIT3"
      exit 2
    fi
  loop: "{{ marketdata_jobs }}"
  loop_control:
    label: "{{ item.key }} ({{ item.dc_label }})"
  register: marketdata_runs
  changed_when: false
  failed_when: false
  args:
    executable: /bin/bash

- name: Normalizar report final
  ansible.builtin.set_fact:
    inicio_jobs_report: >-
      {{
        (inicio_jobs_report | default({}))
        | combine({
            item.item.key: {
              'dc': item.item.dc_label,
              'rc': (item.rc | default(0)),
              'pod': (
                (item.stdout_lines | default([]))
                | select('match', '^__POD__=')
                | map('regex_replace', '^__POD__=', '')
                | list
                | first
                | default('N/A')
              ),
              'status': (
                (item.stdout_lines | default([]))
                | select('match', '^__STATUS__=')
                | map('regex_replace', '^__STATUS__=', '')
                | list
                | last
                | default('N/A')
              ),
              'start_human': (
                (item.stdout_lines | default([]))
                | select('match', '^__START_HUMAN__=')
                | map('regex_replace', '^__START_HUMAN__=', '')
                | list
                | first
                | default('N/A')
              ),
              'end_human': (
                (item.stdout_lines | default([]))
                | select('match', '^__END_HUMAN__=')
                | map('regex_replace', '^__END_HUMAN__=', '')
                | list
                | first
                | default('N/A')
              ),
              'duration_seconds': (
                (
                  (item.stdout_lines | default([]))
                  | select('match', '^__DURATION_SECONDS__=')
                  | map('regex_replace', '^__DURATION_SECONDS__=', '')
                  | list
                  | first
                  | default('0')
                ) | int
              ),
              'exit_ok': (
                (item.stdout | default('')) is search('exit#3', ignorecase=True)
              ),
              'log_tail': (
                (
                  (item.stdout_lines | default([]))
                  [(
                    (item.stdout_lines | default([])).index('__LOG_BEGIN__') + 1
                  ):
                  (
                    (item.stdout_lines | default([])).index('__LOG_END__')
                  )]
                  if ('__LOG_BEGIN__' in (item.stdout_lines | default([]))
                      and '__LOG_END__' in (item.stdout_lines | default([])))
                  else []
                )
                | join('\n')
                | trim
              )
            }
          }, recursive=True)
      }}
  loop: "{{ marketdata_runs.results | default([]) }}"
  changed_when: false
