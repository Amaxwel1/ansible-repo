- name: Consolidar relatório
  hosts: localhost
  gather_facts: false
  vars:
    motivo: "{{ motivo | default('Verificação') }}"
    send_mail_cifs: "producao"
    send_mail_cifs_path: "/Ansible/mail_attachments"
    send_mail_cifs_address:
      tutihofix: "//192.168.0.247/certs"
      producao: "//192.168.0.247/certs"
    cifs_workgroup: "WORKGROUP"
    cifs_tmpdir: "/tmp/patch-verif-{{ awx_job_id | default('job') }}"

  tasks:
    - block:
        - name: Coletar alvos (linux+windows)
          ansible.builtin.set_fact:
            _all_targets: >-
              {{
                ((groups.linux_targets | default([])) + (groups.windows_targets | default([])))
                | map('string') | reject('equalto','') | list | unique
              }}

        - name: Coletar relatórios (1 por host)
          ansible.builtin.set_fact:
            patch_reports: >-
              {{
                _all_targets
                | map('extract', hostvars, 'patch_host_report')
                | select('defined') | list
              }}

        - name: Variáveis seguras (parte 1)
          ansible.builtin.set_fact:
            unreachable_hosts_safe: >-
              {{
                (unreachable_hosts | default([]) | flatten
                  | map('string') | map('trim')
                  | map('regex_replace','[\[\]\"]','')
                  | map('regex_replace',"\\'","")
                  | reject('equalto','')
                  | list | unique)
              }}
            expected_connectable_hosts: "{{ _all_targets }}"
            reported_hosts: "{{ patch_reports | map(attribute='host') | list | unique }}"
            selected_groups: >-
              {{
                (patch_reports
                 | map(attribute='groups')
                 | select('defined')
                 | sum(start=[])) | unique | list
              }}

        - name: Mapear grupos por host (a partir do _groups_norm)
          ansible.builtin.set_fact:
            host_groups_map: >-
              {%- set G = hostvars['localhost']._groups_norm | default({}) -%}
              {%- set out = {} -%}
              {%- for gn, g in G.items() -%}
                {%- for m in (g.members | default([])) -%}
                  {%- set key = (m | string) -%}
                  {%- set _ = out.update({ key: ((out.get(key, []) + [gn]) | unique) }) -%}
                {%- endfor -%}
              {%- endfor -%}
              {{ out }}

        - name: Variáveis seguras (parte 2)
          ansible.builtin.set_fact:
            missing_after_connection: "{{ expected_connectable_hosts | difference(reported_hosts) }}"
            linux_reports: >-
              {%- set out=[] -%}{%- set seen=[] -%}
              {%- for r in patch_reports if r.os == 'linux' -%}
                {%- if r.host not in seen -%}{%- set _ = out.append(r) -%}{%- set _ = seen.append(r.host) -%}{%- endif -%}
              {%- endfor -%}{{ out }}
            windows_reports: >-
              {%- set out=[] -%}{%- set seen=[] -%}
              {%- for r in patch_reports if r.os == 'windows' -%}
                {%- if r.host not in seen -%}{%- set _ = out.append(r) -%}{%- set _ = seen.append(r.host) -%}{%- endif -%}
              {%- endfor -%}{{ out }}

        - name: Calcular se há falhas
          ansible.builtin.set_fact:
            validation_errors_safe: "{{ hostvars['localhost'].validation_errors | default({}) }}"

        - name: Calcular se há falhas
          ansible.builtin.set_fact:
            any_errors: >-
              {{
                (validation_errors_safe.missing_groups | default([]) | length > 0)
                or (validation_errors_safe.missing_envs | default([]) | length > 0)
                or (validation_errors_safe.empty_membership_pairs | default([]) | length > 0)
                or (validation_errors_safe.no_targets | default(false))
                or (patch_reports | length == 0)
                or (unreachable_hosts_safe | length > 0)
                or (missing_after_connection | length > 0)
                or ((patch_reports | map(attribute='services') | sum(start=[]) | selectattr('ok','equalto',False) | list | length) > 0)
                or ((patch_reports
                      | selectattr('ports','defined')
                      | map(attribute='ports')
                      | map(attribute='local')
                      | select('defined')
                      | sum(start=[])
                      | selectattr('ok','equalto',False) | list | length) > 0)
                or ((patch_reports
                      | map(attribute='storage')
                      | select('defined')
                      | sum(start=[])
                      | selectattr('ok','equalto',False) | list | length) > 0)
                or ((patch_reports | map(attribute='commands') | sum(start=[]) | selectattr('rc','!=',0) | list | length) > 0)
                or ((patch_reports | map(attribute='telnet') | select('defined') | sum(start=[]) | selectattr('ok','equalto',False) | list | length) > 0)
              }}

        - name: Montar HTML
          ansible.builtin.set_fact:
            send_mail_body: |
              <style>
                body { font-family: Arial, Helvetica, sans-serif; }
                h2 { margin: 0 0 16px 0; }
                h3 { margin: 18px 0 10px 0; }
                h4 { margin: 14px 0 8px 0; }
                p  { margin: 6px 0 12px 0; }
                table { border-collapse: collapse; width: 100%; font-size: 12px; }
                th, td { border: 1px solid #ddd; padding: 6px 8px; vertical-align: top; }
                th { background: #f7f7f7; text-align: left; }
                .grid { margin: 10px 0 14px 0; }
                .db-table { border-collapse: collapse; width: 100%; font-size: 11px; margin-top:4px; }
                .db-table th, .db-table td { border: 1px solid #eee; padding: 3px 4px; }
                .stdout { white-space: pre-wrap; max-width: 100%; font-family: Consolas, "Courier New", monospace; font-size: 11px; color:#333; }
                .cmdwrap { border:1px solid #e5e5e5; background:#fafafa; padding:8px; border-radius:6px; margin:6px 0 12px 0; }
                .cmdline { font-family: Consolas, "Courier New", monospace; font-size: 11px; color:#111; padding:2px 6px; background:#fff; border:1px solid #eee; border-radius:4px; display:inline-block; }
                .muted { color:#666; font-size:11px; }
              </style>

              {% set norm_map = {'running':'running','active':'running','inactive':'not running','absent':'absent'} %}

              {# --- mapa global de comandos "oficiais" (groups + defaults) --- #}
              {% set ns_all = namespace(linux=[], windows=[]) %}
              {% set groups_norm = hostvars['localhost']._groups_norm | default({}) %}
              {% for gname, g in groups_norm.items() %}
                {% set gl = g.linux | default({}) %}
                {% set gw = g.windows | default({}) %}
                {% set ns_all.linux = (ns_all.linux + (gl.commands | default([]))) | unique %}
                {% set ns_all.windows = (ns_all.windows + (gw.commands | default([]))) | unique %}
              {% endfor %}
              {% set def_lin = hostvars['localhost'].cm.patch_checks.defaults.linux.commands | default([]) %}
              {% set def_win = hostvars['localhost'].cm.patch_checks.defaults.windows.commands | default([]) %}
              {% set ns_all.linux = (ns_all.linux + def_lin) | unique %}
              {% set ns_all.windows = (ns_all.windows + def_win) | unique %}

              <h2>Verificações</h2>
              <p><b>Motivo:</b> {{ motivo | e }}</p>
              {% set ve = hostvars['localhost'].validation_errors | default({}) %}

              {% if ve.missing_groups is defined and (ve.missing_groups | length) > 0 %}
                <p style="color:#b00020;"><b>ERRO:</b> Grupos selecionados não existem no projeto atual: {{ ve.missing_groups | join(', ') }}</p>
              {% endif %}

              {% if ve.missing_envs is defined and (ve.missing_envs | length) > 0 %}
                <p style="color:#b00020;"><b>ERRO:</b> Envs selecionados não existem no projeto atual: {{ ve.missing_envs | join(', ') }}</p>
              {% endif %}

              {% if ve.empty_membership_pairs is defined and (ve.empty_membership_pairs | length) > 0 %}
                <p style="color:#f0ad4e;"><b>ALERTA:</b> Existem combinações env+grupo sem members.</p>
              {% endif %}

              {% if ve.no_targets | default(false) %}
                <p style="color:#b00020;"><b>ERRO:</b> Nenhum host alvo foi resolvido. Possível causa: projeto desatualizado no AAP.</p>
              {% endif %}

              {% if patch_reports | length == 0 %}
                <p style="color:#b00020;"><b>ERRO:</b> Nenhuma checagem foi executada (não houve relatório gerado).</p>
              {% endif %}
              {% if selected_groups|length > 0 %}
                <p><b>Grupos aplicados:</b> {{ selected_groups | join(', ') }}</p>
              {% endif %}

              {% if (unreachable_hosts_safe | length) > 0 %}
              <h3 style="color:#b00020;">Hosts inalcançáveis</h3>
              <ul>{% for h in unreachable_hosts_safe %}<li>{{ h }}</li>{% endfor %}</ul>
              {% endif %}

              {% if (missing_after_connection | length) > 0 %}
              <h3 style="color:#f0ad4e;">Hosts sem relatório (timeout/falha de execução)</h3>
              <ul>{% for h in missing_after_connection %}<li>{{ h }}</li>{% endfor %}</ul>
              {% endif %}

              {% set all_groups_from_map = (host_groups_map.values() | sum(start=[])) | unique | list %}
              {% set groups_to_render = (selected_groups if selected_groups|length>0 else all_groups_from_map) %}

              {% macro render_group(gname) -%}
                {% set reps = [] %}
                {% for rep in patch_reports | list %}
                  {% set grps = host_groups_map.get(rep.host, []) %}
                  {% if gname in grps %}
                    {% set _ = reps.append(rep) %}
                  {% endif %}
                {% endfor %}

                {% if reps|length > 0 %}
                  {% set groups_norm = hostvars['localhost']._groups_norm | default({}) %}
                  {% set gnorm = groups_norm.get(gname, {}) %}

                  <h3>Grupo: {{ gname }}</h3>
                  <table class="grid">
                    <tr>
                      <th style="width:220px;">Host</th>
                      <th style="width:34%;">Serviços</th>
                      <th style="width:16%;">Portas</th>
                      <th style="width:16%;">Discos</th>
                      <th style="width:18%;">Telnet</th>
                    </tr>
                    {% for rep in reps %}
                      {% if rep.os == 'windows' %}
                        {% set gdef = gnorm.windows | default({}) %}
                        {% set def_cmds = hostvars['localhost'].cm.patch_checks.defaults.windows.commands | default([]) %}
                      {% else %}
                        {% set gdef = gnorm.linux | default({}) %}
                        {% set def_cmds = hostvars['localhost'].cm.patch_checks.defaults.linux.commands | default([]) %}
                      {% endif %}

                      {% set g_svc_names = [] %}
                      {% for it in (gdef.services | default([])) %}
                        {% if it is mapping %}
                          {% set _ = g_svc_names.append(it.name | default(it.service | default('')) | string | trim) %}
                        {% else %}
                          {% set _ = g_svc_names.append(it | string | trim) %}
                        {% endif %}
                      {% endfor %}
                      {% set g_svc_names = g_svc_names | reject('equalto','') | list | unique %}

                      {% set g_ports     = (gdef.ports | default([]) | map('string') | list) %}
                      {% set g_cmds      = (gdef.commands | default([]) + def_cmds) | unique %}
                      {% set g_telnet    = (gdef.telnet | default([])) | unique %}

                      {% set svc_rows_all = rep.services | default([]) %}
                      {% if rep.ports is defined and rep.ports.local is defined %}
                        {% set local_rows_all = rep.ports.local %}
                      {% else %}
                        {% set local_rows_all = [] %}
                      {% endif %}
                      {% set sto_rows = rep.storage | default([]) %}
                      {% set cmd_rows_all = rep.commands | default([]) %}
                      {% set tel_rows_all = rep.telnet | default([]) %}

                      <tr>
                        <td><b>{{ rep.host }}</b></td>

                        <td>
                          {% set ns_svc = namespace(any=false) %}
                          {% if svc_rows_all|length > 0 %}
                            {% for s in svc_rows_all %}
                              {% if s.name in g_svc_names %}
                                {% set ns_svc.any = true %}
                                {% set exp = (s.expected | default('running') | lower) %}
                                {% set raw = (s.state | string | lower | trim) %}
                                {% set is_ok = (s.ok | default(false)) %}

                                {% if exp == 'stopped' %}
                                  {% set label = 'stopped' if is_ok else 'running (deveria estar stopped)' %}
                                {% else %}
                                  {% if raw == 'absent' %}
                                    {% set label = 'não existe' %}
                                  {% else %}
                                    {% set label = 'running' if is_ok else 'not running' %}
                                  {% endif %}
                                {% endif %}

                                <div>
                                  {{ s.name }}
                                  <span style="font-weight:bold;color:{{ 'green' if is_ok else '#b00020' }};">
                                    {{ label }}
                                  </span>

                                  {% if s.attempted_restart | default(false) %}
                                    {% if is_ok %}
                                      <span class="muted">(reiniciado)</span>
                                    {% else %}
                                      <span class="muted">(tentativa de restart)</span>
                                    {% endif %}
                                  {% endif %}
                                </div>
                              {% endif %}
                            {% endfor %}
                          {% endif %}
                          {% if not ns_svc.any %}—{% endif %}
                        </td>

                        <td>
                          {% set ns_port = namespace(any=false) %}
                          {% if local_rows_all|length > 0 %}
                            {% for p in local_rows_all %}
                              {% if (p.port | string) in g_ports %}
                                {% set ns_port.any = true %}
                                <div>
                                  {{ p.port }}
                                  <span style="font-weight:bold;color:{{ 'green' if p.ok else '#b00020' }};">
                                    {{ 'OK' if p.ok else 'Falha' }}
                                  </span>
                                </div>
                              {% endif %}
                            {% endfor %}
                          {% endif %}
                          {% if not ns_port.any %}—{% endif %}
                        </td>

                        <td>
                          {% if sto_rows|length > 0 %}
                            {% for e in sto_rows %}
                              <div>
                                {{ e.mount }}:
                                <span style="font-weight:bold;color:{{ 'green' if e.ok else '#b00020' }};">
                                  {{ e.usage }}%
                                </span>
                              </div>
                            {% endfor %}
                          {% else %}—{% endif %}
                        </td>

                        <td>
                          {% set ns_tel = namespace(any=false) %}
                          {% if tel_rows_all|length > 0 %}
                            {% for t in tel_rows_all %}
                              {% if (t.group | lower) == (gname | lower) %}
                                {% set ns_tel.any = true %}
                                <div>
                                  {{ t.target }}
                                  <span style="font-weight:bold;color:{{ 'green' if t.ok else '#b00020' }};">
                                    {{ 'OK' if t.ok else 'Falha' }}
                                  </span>
                                </div>
                              {% endif %}
                            {% endfor %}
                          {% endif %}
                          {% if not ns_tel.any %}—{% endif %}
                        </td>
                      </tr>
                    {% endfor %}
                  </table>

                  {# Detalhes de comandos (sem DB, incluindo extras tipo pwd) #}
                  {% set reps_with_cmds = reps | selectattr('commands','defined') | list %}
                  {% if reps_with_cmds|length > 0 %}
                    <h4>Detalhes de comandos – {{ gname }}</h4>
                    {% for rep in reps_with_cmds %}
                      {% if rep.os == 'windows' %}
                        {% set gdef = gnorm.windows | default({}) %}
                        {% set def_cmds = hostvars['localhost'].cm.patch_checks.defaults.windows.commands | default([]) %}
                        {% set global_cmds = ns_all.windows %}
                      {% else %}
                        {% set gdef = gnorm.linux | default({}) %}
                        {% set def_cmds = hostvars['localhost'].cm.patch_checks.defaults.linux.commands | default([]) %}
                        {% set global_cmds = ns_all.linux %}
                      {% endif %}
                      {% set g_cmds = (gdef.commands | default([]) + def_cmds) | unique %}

                      {% set cmds = [] %}
                      {% for c in rep.commands | default([]) %}
                        {% set cmd_text = c.cmd | default('') | string %}
                        {% set is_db = cmd_text.startswith('DB(') %}
                        {# entra se:
                           - for comando oficial do grupo (g_cmds)
                           - OU comando extra de host (não-DB e não está em nenhum global_cmds)
                        #}
                        {% if (cmd_text in g_cmds) or (not is_db and (cmd_text not in global_cmds)) %}
                          {% set _ = cmds.append(c) %}
                        {% endif %}
                      {% endfor %}

                      {% if cmds|length > 0 %}
                        <div class="muted"><b>{{ rep.host }}</b></div>
                        {% for c in cmds %}
                          {% set out = (c.stdout | default('') | string) %}
                          {% set err = (c.stderr | default('') | string) %}
                          {% set ok  = (c.rc | default(1)) == 0 %}

                          <div class="cmdwrap">
                            <span class="cmdline">{{ c.cmd }}</span>

                            {% if out | trim | length > 0 %}
                              <div class="muted">stdout:</div>
                              <pre class="stdout">{{ out[0:2000] }}</pre>
                            {% endif %}

                            {% if err | trim | length > 0 %}
                              <div class="muted">stderr:</div>
                              <pre class="stdout">{{ err[0:2000] }}</pre>
                            {% endif %}

                            {% if (out | trim | length == 0) and (err | trim | length == 0) %}
                              <pre class="stdout">— (sem saída)</pre>
                            {% endif %}
                          </div>
                        {% endfor %}
                      {% endif %}
                    {% endfor %}
                  {% endif %}

                  {# Detalhes de queries de banco (DB(gname): ...) #}
                  {% set reps_with_db = reps | selectattr('commands','defined') | list %}
                  {% set ns_db = namespace(found=false) %}
                  {% for rep in reps_with_db %}
                    {% for c in rep.commands | default([]) %}
                      {% set cmd_l = (c.cmd | default('') | lower) %}
                      {% if ('db(' ~ gname|lower ~ '):') in cmd_l %}
                        {% set ns_db.found = true %}
                      {% endif %}
                    {% endfor %}
                  {% endfor %}

                  {% if ns_db.found %}
                    <h4>Detalhes de queries – {{ gname }}</h4>
                    <table class="grid">
                      <tr>
                        <th style="width:220px;">Host</th>
                        <th style="width:180px;">Query</th>
                        <th>SQL</th>
                        <th style="width:80px;">Status</th>
                      </tr>
                      {% for rep in reps_with_db %}
                        {% for c in rep.commands | default([]) %}
                          {% set cmd_l = (c.cmd | default('') | lower) %}
                          {% if ('db(' ~ gname|lower ~ '):') in cmd_l %}
                            {% set qname = c.query_name | default('') %}
                            {% set qsql  = c.sql | default('') %}
                            <tr>
                              <td><b>{{ rep.host }}</b></td>
                              <td>
                                <div class="cmdwrap">
                                  <span class="cmdline">{{ qname if qname|length>0 else c.cmd }}</span>
                                </div>
                              </td>
                              <td>
                                <div class="cmdwrap">
                                  <pre class="stdout">{{ (qsql | string)[0:2000] }}</pre>

                                  {% if c.stdout %}
                                    {% set out = (c.stdout | string)[0:2000] %}
                                    {% set lines = out.split('\n') %}
                                    <table class="db-table">
                                      {% for line in lines %}
                                        {% set line = line | trim %}
                                        {% if line %}
                                          {% set cols = line.split('|') %}
                                          {% if loop.first %}
                                            <tr>
                                              {% for col in cols %}
                                                <th>{{ col }}</th>
                                              {% endfor %}
                                            </tr>
                                          {% else %}
                                            <tr>
                                              {% for col in cols %}
                                                <td>{{ col }}</td>
                                              {% endfor %}
                                            </tr>
                                          {% endif %}
                                        {% endif %}
                                      {% endfor %}
                                    </table>
                                  {% endif %}
                                </div>
                              </td>
                              <td>
                                <span style="font-weight:bold;color:{{ 'green' if c.rc == 0 else '#b00020' }};">
                                  {{ 'OK' if c.rc == 0 else 'Falha' }}
                                </span>
                              </td>
                            </tr>
                          {% endif %}
                        {% endfor %}
                      {% endfor %}
                    </table>
                  {% endif %}

                  {# Detalhes de IIS (se existir config no grupo) #}
                  {% set gwin = gnorm.windows | default({}) %}
                  {% set iis_cfg = gwin.iis_pools | default([]) %}
                  {% if iis_cfg | length > 0 %}
                    {% set ns_iis = namespace(entries=[]) %}
                    {% for rep in reps %}
                      {% if rep.os == 'windows' %}
                        {% set host_iis = hostvars[rep.host]._iis_pools_report | default([]) %}
                        {% for e in host_iis %}
                          {% set _ = ns_iis.entries.append(e | combine({'host': rep.host})) %}
                        {% endfor %}
                      {% endif %}
                    {% endfor %}

                    {% if ns_iis.entries | length > 0 %}
                      <h4>Detalhes de IIS – {{ gname }}</h4>
                      <table class="grid">
                        <tr>
                          <th style="width:220px;">Host</th>
                          <th>Pool</th>
                          <th>Estado inicial</th>
                          <th>Estado final</th>
                          <th>Ação</th>
                          <th style="width:80px;">Status</th>
                        </tr>
                        {% for e in ns_iis.entries %}
                          <tr>
                            <td><b>{{ e.host }}</b></td>
                            <td>{{ e.name }}</td>
                            <td>{{ e.initial_state }}</td>
                            <td>{{ e.final_state }}</td>
                            <td>{{ e.action }}</td>
                            <td>
                              <span style="font-weight:bold;color:{{ 'green' if e.ok else '#b00020' }};">
                                {{ 'OK' if e.ok else 'Falha' }}
                              </span>
                            </td>
                          </tr>
                        {% endfor %}
                      </table>
                    {% endif %}
                  {% endif %}
                {% endif %}
              {%- endmacro %}

              {% for g in groups_to_render %}
                {{ render_group(g) }}
              {% endfor %}

              {% if not any_errors %}
                <p style="color:green;"><b>Todas as checagens passaram.</b></p>
              {% else %}
                <p style="color:#b00020;"><b>Existem falhas – ver destaque nas seções.</b></p>
              {% endif %}

        # CIFS
        - name: Definir tmpdir (compat)
          ansible.builtin.set_fact:
            tmpdir: "{{ '/tmp/patch-verif' }}"
          delegate_to: 192.168.0.247

        - name: Ensure tmpdir exists
          ansible.builtin.file:
            path: "{{ tmpdir }}"
            state: directory
            mode: "0755"
          delegate_to: 192.168.0.247

        - name: Coletar anexos de diagnósticos (restart falhou) - local paths
          ansible.builtin.set_fact:
            _diag_files_raw: >-
              {{
                (_all_targets
                  | map('extract', hostvars, 'patch_diag_attachments')
                  | select('defined')
                  | sum(start=[]))
                | map('string') | map('trim')
                | reject('equalto','')
                | unique
                | list
              }}

        - name: Verificar anexos
          ansible.builtin.stat:
            path: "{{ item }}"
          register: _diag_stats
          changed_when: false
          failed_when: false
          loop: "{{ _diag_files_raw }}"
          when: (_diag_files_raw | length) > 0
          delegate_to: 192.168.0.247

        - name: Filtrar anexos válidos
          ansible.builtin.set_fact:
            _mail_attachments_local: >-
              {{
                (_diag_stats.results | default([]))
                | selectattr('stat.exists','defined')
                | selectattr('stat.exists')
                | selectattr('stat.size','defined')
                | selectattr('stat.size','>',0)
                | map(attribute='stat.path')
                | list
              }}

        - name: Normalizar config CIFS
          ansible.builtin.set_fact:
            _cifs_server: "{{ send_mail_cifs_address[send_mail_cifs | lower] }}"
            _cifs_dir: "{{ send_mail_cifs_path }}"
            _cifs_user: "{{ ansible_user | default('') }}"
            _cifs_pass: "{{ ansible_password | default('') }}"
            _cifs_workgroup: "{{ cifs_workgroup | default('WORKGROUP') }}"
            _cifs_password_file: "{{ cifs_tmpdir }}/.cifs-pass"
          no_log: true
          delegate_to: 192.168.0.247

        - name: Fail early se CIFS mapping estiver faltando
          ansible.builtin.fail:
            msg: "CIFS não mapeado: send_mail_cifs='{{ send_mail_cifs }}' não existe em send_mail_cifs_address."
          when: _cifs_server is not defined or (_cifs_server | length) == 0

        - name: Criar arquivo para autenticação no CIFS
          ansible.builtin.copy:
            dest: "{{ _cifs_password_file }}"
            content: "{{ _cifs_pass }}"
            mode: "0600"
          no_log: true
          delegate_to: 192.168.0.247

        - name: Testar acesso ao CIFS
          ansible.builtin.shell: >
            smbclient "{{ _cifs_server }}"
            -U "{{ _cifs_user }}%$(cat {{ _cifs_password_file }})"
            -W "{{ _cifs_workgroup }}"
            -c "ls {{ _cifs_dir }}"
          register: _cifs_probe
          retries: 5
          delay: 10
          until: _cifs_probe.rc == 0
          changed_when: false
          delegate_to: 192.168.0.247

        - name: Subir diagnósticos para CIFS (svc_diag_*.txt)
          ansible.builtin.shell: >
            smbclient "{{ _cifs_server }}"
            -U "{{ _cifs_user }}%$(cat {{ _cifs_password_file }})"
            -W "{{ _cifs_workgroup }}"
            -c 'cd {{ _cifs_dir }} ; put {{ item }} {{ ("diag_" ~ (awx_job_id | default("job")) ~ "_" ~ (item | basename)) }}'
          changed_when: true
          loop: "{{ _mail_attachments_local | default([]) }}"
          register: _cifs_put_diags
          when: (_mail_attachments_local | default([]) | length) > 0
          delegate_to: 192.168.0.247

        - name: Montar lista de arquivos remotos no CIFS para o e-mail baixar e anexar
          ansible.builtin.set_fact:
            send_mail_cifs_remote_files: >-
              {{
                (_mail_attachments_local | default([]))
                | map('basename')
                | map('regex_replace', '^', 'diag_' ~ (awx_job_id | default('job')) ~ '_')
                | list
              }}

        - name: Remover arquivo de senha temporário (CIFS)
          ansible.builtin.file:
            path: "{{ _cifs_password_file }}"
            state: absent
          no_log: true
          delegate_to: 192.168.0.247

        - name: Coletar anexos de diagnósticos (restart falhou)
          ansible.builtin.set_fact:
            _diag_files_raw: >-
              {{
                (_all_targets
                  | map('extract', hostvars, 'patch_diag_attachments')
                  | select('defined')
                  | sum(start=[]))
                | map('string') | map('trim')
                | reject('equalto','')
                | unique
                | list
              }}

        - name: Verificar anexos no controller
          when: (_diag_files_raw | default([])) | length > 0
          ansible.builtin.stat:
            path: "{{ item }}"
          register: _diag_stats
          changed_when: false
          failed_when: false
          loop: "{{ _diag_files_raw }}"
          delegate_to: 192.168.0.247

        - name: Filtrar anexos válidos
          ansible.builtin.set_fact:
            _mail_attachments: >-
              {{
                (_diag_stats.results | default([]))
                | selectattr('stat.exists','defined')
                | selectattr('stat.exists')
                | selectattr('stat.size','defined')
                | selectattr('stat.size','>',0)
                | map(attribute='stat.path')
                | list
              }}

        - name: Definir subject/body para envio
          ansible.builtin.set_stats:
            data:
              send_mail_subject: "Ansible-Report – Job #{{ awx_job_id | default('N/A') }} - {{ awx_job_template_name | default('Patch Verification') }} – {{ 'SUCESSO' if not any_errors else 'ALERTA' }}"
              send_mail_body: "{{ send_mail_body }}"
              send_mail_cifs: "{{ send_mail_cifs }}"
              send_mail_cifs_path: "{{ send_mail_cifs_path }}"
              send_mail_cifs_address: "{{ send_mail_cifs_address }}"
              cifs_workgroup: "{{ cifs_workgroup | default('WORKGROUP') }}"
              send_mail_cifs_remote_files: "{{ send_mail_cifs_remote_files | default([]) }}"

      rescue:
        - name: Subject de alerta em caso de falha no relatório
          ansible.builtin.set_fact:
            _err_subject: "Ansible-Report – Job #{{ awx_job_id | default('N/A') }} - {{ awx_job_template_name | default('Patch Verification') }} – ALERTA"

        - name: Corpo de alerta com detalhes do erro
          ansible.builtin.set_fact:
            send_mail_body: |
              <style>
                body { font-family: Arial, Helvetica, sans-serif; }
                h2 { margin: 0 0 16px 0; }
                p  { margin: 6px 0 14px 0; }
                pre { white-space: pre-wrap; }
              </style>
              <h2 style="color:#b00020">Falha ao consolidar relatório</h2>
              <p>O relatório encontrou um erro e não foi possível montar as tabelas completas.</p>
              <p><b>Tarefa:</b> {{ ansible_failed_task.name | default('desconhecida') }}</p>
              <pre>{{ (ansible_failed_result.msg | default(ansible_failed_result | to_nice_json | default(''))) }}</pre>

        - name: Publicar subject/body de alerta
          ansible.builtin.set_stats:
            data:
              send_mail_subject: "{{ _err_subject }}"
              send_mail_body: "{{ send_mail_body }}"
