- name: Check if attachment file exists
  ansible.builtin.stat:
    path: "{{ must_gather_file }}"
    get_checksum: true
    checksum_algorithm: sha1
    get_mime: true
  register: attachment_file
  become: true
  become_user: root

- name: Fail if file does not exist
  ansible.builtin.fail:
    msg: "Arquivo nÃ£o existe no host: {{ must_gather_file }}"
  when: not attachment_file.stat.exists

- name: Validate gzip before attach
  ansible.builtin.shell: |
    set -euo pipefail
    gzip -t "{{ must_gather_file }}"
  args:
    executable: /bin/bash
  changed_when: false
  become: true
  become_user: root

- name: Ensure sshpass is available
  ansible.builtin.package:
    name: sshpass
    state: present
  become: true
  become_user: root
  failed_when: false

- name: Ensure nc is available
  ansible.builtin.package:
    name: nc
    state: present
  become: true
  become_user: root
  failed_when: false

- name: Build upload report
  ansible.builtin.set_fact:
    mg_size_bytes: "{{ attachment_file.stat.size | int }}"
    mg_size_human: >-
      {{
        (
          ((attachment_file.stat.size | int) / 1024 / 1024 / 1024) | round(2) | string ~ " GB"
        ) if ((attachment_file.stat.size | int) >= (1024**3)) else
        (
          ((attachment_file.stat.size | int) / 1024 / 1024) | round(2) | string ~ " MB"
        )
      }}
  changed_when: false

- name: Validate SFTP inputs
  ansible.builtin.assert:
    that:
      - (case_id | default('') | trim) != ''
      - (ocp_must_gather_case_token | default('') | trim) != ''
      - (rh_portal_user | default('') | trim) != ''
    fail_msg: "Para anexar via SFTP, informe case_id, ocp_must_gather_case_token e rh_portal_user."
  changed_when: false

- name: Upload must-gather via SFTP
  ansible.builtin.shell: |
    set -euo pipefail

    sshpass -p "{{ ocp_must_gather_case_token }}" \
      sftp -P 80 \
        -o StrictHostKeyChecking=no \
        -o UserKnownHostsFile=/dev/null \
        -o "ProxyCommand nc --proxy {{ ocp_must_gather_proxy }} --proxy-auth {{ ocp_must_gather_proxy_auth }} --proxy-type http %h %p" \
        "{{ rh_portal_user }}@sftp.access.redhat.com" <<EOF
      cd {{ rh_portal_user }}
      put {{ must_gather_file }} {{ case_id }}_{{ must_gather_file | basename }}
      bye
      EOF
  args:
    executable: /bin/bash
  register: sftp_upload
  no_log: true
  become: true
  become_user: root
  until: sftp_upload.rc == 0
  retries: 3
  delay: 10

- name: Upload report
  ansible.builtin.debug:
    msg:
      - "case_id={{ case_id }}"
      - "file={{ must_gather_file }}"
      - "size={{ mg_size_human }}"
      - "sha1={{ attachment_file.stat.checksum | default('n/a') }}"
      - "sftp_rc={{ sftp_upload.rc | default('n/a') }}"
      - "sftp_stdout={{ (sftp_upload.stdout | default('')) | regex_replace('\\n+$','') }}"
      - "sftp_stderr={{ (sftp_upload.stderr | default('')) | regex_replace('\\n+$','') }}"
