---
- name: Create a refresh token
  ansible.builtin.shell: |
    curl -sS https://sso.redhat.com/auth/realms/redhat-external/protocol/openid-connect/token \
      -d grant_type=refresh_token \
      -d client_id=rhsm-api \
      -d refresh_token={{ offline_token }}
  register: access_token_out
  no_log: true
  delegate_to: localhost

- name: Save access token in var
  ansible.builtin.set_fact:
    access_token: "{{ (access_token_out.stdout | from_json).access_token }}"
  no_log: true
  delegate_to: localhost

- name: Usar Case existente quando informado no survey
  ansible.builtin.set_fact:
    case_id: "{{ ocp_must_gather_existing_case_id | trim }}"
    case_mode: "attach_only"
  when: (ocp_must_gather_existing_case_id | default('') | trim) != ''
  delegate_to: localhost

- name: Validar formato do Case ID (somente números) quando informado
  ansible.builtin.assert:
    that:
      - (case_id | string) is match('^[0-9]+$')
    fail_msg: "Case ID inválido: '{{ case_id }}'. Informe somente números."
  when: (ocp_must_gather_existing_case_id | default('') | trim) != ''
  delegate_to: localhost

- name: Create a case in Red Hat Portal
  ansible.builtin.uri:
    url: "https://api.access.redhat.com/support/v1/cases"
    method: POST
    headers:
      Authorization: "Bearer {{ access_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      product: "{{ product }}"
      severity: "{{ case_severity }}"
      version: "{{ openshift_version }}"
      summary: "{{ case_summary }}"
      description: "{{ case_description }}"
      accountNumberRef: "{{ accountNumberRef }}"
      openshiftClusterID: "{{ cluster_id[0] }}"
      caseType: "{{ case_type }}"
    return_content: true
    status_code: [200, 201]
  register: redhat_case_creation
  delegate_to: localhost
  when: (ocp_must_gather_existing_case_id | default('') | trim) == ''

- name: Extract Case ID from response
  ansible.builtin.set_fact:
    case_id: "{{ redhat_case_creation.json.location[0].split('/')[-1] }}"
    case_mode: "created"
  delegate_to: localhost
  when: (ocp_must_gather_existing_case_id | default('') | trim) == ''

- name: Validar que o Case existe (GET) quando attach_only
  ansible.builtin.uri:
    url: "https://api.access.redhat.com/support/v1/cases/{{ case_id }}"
    method: GET
    headers:
      Authorization: "Bearer {{ access_token }}"
    status_code: [200]
  register: _case_get
  delegate_to: localhost
  when: (case_mode | default('')) == 'attach_only'

- name: Check if attachment file exists
  ansible.builtin.stat:
    path: "{{ must_gather_file }}"
    get_checksum: true
    checksum_algorithm: sha1
    get_mime: true
  register: attachment_file

- name: Fail if file does not exist
  ansible.builtin.fail:
    msg: "Arquivo não existe no host: {{ must_gather_file }}"
  when: not attachment_file.stat.exists

- name: Validar gzip antes do upload
  ansible.builtin.shell: |
    set -e
    gzip -t "{{ must_gather_file }}"
  args:
    executable: /bin/bash
  changed_when: false
  become: true
  become_user: root

- name: Upload attachment via curl
  ansible.builtin.shell: |
    set -euo pipefail

    RESP="/tmp/rh_attach_{{ case_id }}.resp"
    CODE="/tmp/rh_attach_{{ case_id }}.code"

    curl -sS --fail \
      --connect-timeout 20 \
      --max-time 3600 \
      --retry 3 --retry-delay 10 --retry-connrefused \
      -o "$RESP" -w "%{http_code}" > "$CODE" \
      -H "Authorization: Bearer {{ access_token }}" \
      -F "file=@{{ must_gather_file }};type=application/gzip;filename={{ must_gather_file | basename }}" \
      "https://api.access.redhat.com/support/v1/cases/{{ case_id }}/attachments"

    echo "HTTP=$(cat "$CODE")"
    tail -c 600 "$RESP" || true
  args:
    executable: /bin/bash
  register: attachment_upload
  no_log: true
  changed_when: true
  become: true
  become_user: root

- name: Fail se upload não retornou 200/201
  ansible.builtin.fail:
    msg: "Upload falhou. Saída: {{ attachment_upload.stdout | default('') }} {{ attachment_upload.stderr | default('') }}"
  when: attachment_upload.rc != 0

- name: Debug upload output (curl)
  ansible.builtin.debug:
    msg:
      - "case_id={{ case_id }}"
      - "file={{ must_gather_file }}"
      - "size={{ attachment_file.stat.size | default('n/a') }}"
      - "sha1={{ attachment_file.stat.checksum | default('n/a') }}"
      - "{{ attachment_upload.stdout | default('') }}"
      - "{{ attachment_upload.stderr | default('') }}"
